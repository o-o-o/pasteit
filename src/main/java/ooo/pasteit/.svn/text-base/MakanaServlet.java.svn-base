package ooo.makana;

import java.io.File;
import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class MakanaServlet extends HttpServlet {

	private static final long serialVersionUID = 6712349714840057898L;
	private static final String STORAGE = "var";

	private File storage;

	@Override
	public void init() throws ServletException {
		storage = new File(FileUtils.getUserDir(), STORAGE);
		if (!storage.exists()) storage.mkdirs();
	}

	@Override
	protected void doPost(final HttpServletRequest request, final HttpServletResponse response) throws ServletException, IOException {
		final String q = request.getParameter("q");
		if (q == null) response.sendRedirect("/");
		final String key = new String(Long.toHexString(System.currentTimeMillis()));
		FileUtils.write(new File(storage, key), q);
		response.sendRedirect("/t/" + key);
	}

	@Override
	protected void doGet(final HttpServletRequest request, final HttpServletResponse response) throws ServletException, IOException {
		final String uri = request.getRequestURI();
		final File file = new File(storage, uri.substring(uri.lastIndexOf("/") + 1, uri.length()));
		if (!file.exists() || !file.isFile()) {
			response.sendRedirect("/");
			return;
		}
		if (!storage.equals(file.getParentFile())) {
			response.sendRedirect("/");
			return;
		}
		request.setAttribute("text", FileUtils.read(file));
		// FIXME not good.
		request.setAttribute("location", request.getRequestURL().toString());
		request.getRequestDispatcher("/WEB-INF/jsp/view.jsp").forward(request, response);
	}
}